---
title: "Calculate Distances"
author: "Annie Bryant"
date: "7/23/2020"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE, warning=F)
```

```{r}
library(oro.nifti)
library(tidyverse)
library(neurobase)
library(freesurferformats)
library(ggpubr)
library(colorspace)
library(ggplotify)
library(EBImage)
library(icesTAF)
library(knitr)
library(kableExtra)
library(readxl)
library(forcats)
rm(list=ls())
```


The purpose of this .Rmd is to create a dataframe that contains each pairwise combination of regions of interest (ROIs) from two different FreeSurfer cortical parcellation schemes: the Desikan/Killiany atlas (aparc+aseg.nii.gz) and the Destrieux atlas (aparc.a2009s+aseg.nii.gz). The two cover the same overall volume, but the Destrieux atlas offers finer granularity (i.e. multiple cortical subregion per region in the Desikan/Killiany atlas). The number of white matter tracts passing through each pairwise ROI combination was calculated in DSI Studio (add more writeup later). The absolute distance between ROIs is calculated as the Euclidean Distance between the three-dimensional centroid for each of the two ROIs.


First, the atlas information is encoded as voxel intensity values in the two NIFTI (.nii.gz) volumes. These are detailedin the below spreadsheet for lookup.
```{r}
freesurfer_codes <- read_excel("../FreeSurfer/FS_Codes.xlsx")
```


Read in the Desikan/Killiany atlas using readNIfTI from oro.nifti. img_colour_df takes a three-dimensional image volume and converts it to a dataframe with one row per voxel, encoding the x/y/z coordinates and intensity value. This intensity value maps to atlas parcellations detailed in the FS_Codes spreadsheet, which can be used to define the anatomical region into which every single voxel is classified.
```{r}
aseg.mni.fs <- img_colour_df(readNIfTI("../FreeSurfer/aparc+aseg.nii.gz")) %>%
  select(-zi, -colour) %>% 
  rename("x"="dim1", "y"="dim2", "z"="dim3", "Index"="value") %>%
  filter(Index>1) %>%
  left_join(., freesurfer_codes)
```

To show a sample:
```{r}
aseg.mni.fs %>%
  sample_n(5) %>%
  kable(., booktabs=T) %>%
  kable_styling(full_width=F)
```

The same is done for the Destrieux atlas:
```{r}
# aparc.aseg.2009s.mni <- img_colour_df(readNIfTI("../FreeSurfer/aparc.a2009s+aseg.nii.gz")) %>%
#   select(-zi, -colour) %>% 
#   rename("x"="dim1", "y"="dim2", "z"="dim3", "Index"="value") %>%
#   filter(Index>1) %>%
#   left_join(., freesurfer_codes)
```

To show a sample:
```{r}
# aparc.aseg.2009s.mni %>%
#   sample_n(5) %>%
#   kable(., booktabs=T) %>%
#   kable_styling(full_width=F)
```

For these two atlases, I calculate the centroid by taking the average x, y, and z coordinates, respectively, for each ROI.

```{r}
aseg.mni.fs.centroids <- aseg.mni.fs %>%
  filter(!is.na(FS_Name)) %>%
  group_by(Index, FS_Name, Description) %>%
  summarise(Centroid_x = mean(x), Centroid_y=mean(y), Centroid_z=mean(z)) %>%
  ungroup() %>%
  # Indices 1000 and 2000 indicate unknown ROI, discard
  filter(!(Index %in% c(1000, 2000))) %>%
  select(-Index, -Description) %>%
  rename("ROI1" = "FS_Name")

# aparc.aseg.mni.fs.centroids <- aparc.aseg.2009s.mni %>%
#   filter(!is.na(FS_Name)) %>%
#   group_by(Index, FS_Name, Description) %>%
#   summarise(Centroid_x = mean(x), Centroid_y=mean(y), Centroid_z=mean(z)) %>%
#   ungroup() %>%
#   # Indices 11100 and 12100 indicate unknown ROI, discard
#   filter(!(Index %in% c(11100, 12100))) %>%
#   select(-Index, -Description) %>%
#   rename("ROI1" = "FS_Name")
```

To show a sample:
```{r}
aseg.mni.fs.centroids %>%
  sample_n(5) %>%
  kable(., booktabs=T) %>%
  kable_styling(full_width=F)
```


Pairwise combinations of ROIs are automatically tabulated using the `combn()` function. The Euclidean Distance between centroids in each pairwise combination is calculated to reflect absolute spatial distance between each pair of ROIs.

```{r}
aseg.mni.fs.dists <- as.data.frame(t(combn(aseg.mni.fs.centroids$ROI1, m=2))) %>%
  rename("ROI1" = "V1", "ROI2" = "V2") %>%
  left_join(aseg.mni.fs.centroids) %>%
  left_join(aseg.mni.fs.centroids, by=c("ROI2"="ROI1"), suffix=c("1", "2")) %>%
  group_by(ROI1, ROI2) %>%
  summarise(Euclidean_Distance = sqrt(sum( (Centroid_x1-Centroid_x2)^2 + (Centroid_y1-Centroid_y2)^2 + (Centroid_z1-Centroid_z2)^2 ))) %>%
  mutate(smushed = ifelse(ROI1<ROI2, paste(ROI1, ROI2, sep="_"),
         paste(ROI2, ROI1, sep="_")))

# aparc.aseg.mni.fs.dists <- as.data.frame(t(combn(aparc.aseg.mni.fs.centroids$ROI1, m=2))) %>%
#   rename("ROI1" = "V1", "ROI2" = "V2") %>%
#   left_join(aparc.aseg.mni.fs.centroids) %>%
#   left_join(aparc.aseg.mni.fs.centroids, by=c("ROI2"="ROI1"), suffix=c("1", "2")) %>%
#   group_by(ROI1, ROI2) %>%
#   summarise(Euclidean_Distance = sqrt(sum( (Centroid_x1-Centroid_x2)^2 + (Centroid_y1-Centroid_y2)^2 + (Centroid_z1-Centroid_z2)^2 ))) %>%
#   mutate(smushed = ifelse(ROI1<ROI2, paste(ROI1, ROI2, sep="_"),
#          paste(ROI2, ROI1, sep="_")))

#fs.roi.euc.dists <- plyr::rbind.fill(aparc.aseg.mni.fs.dists, aseg.mni.fs.dists) %>% distinct()
  
```

To show a sample:
```{r}
# fs.roi.euc.dists %>%
#   sample_n(5) %>%
#   select(-smushed) %>%
#   kable(., booktabs=T) %>%
#   kable_styling(full_width=F)
```


write blurb about diffusion tensor imaging/ODF/DSI studio
connectivity matrix was calculated from DSI studio based on CMU-60 template and the same two FreeSurfer atlases described above and exported as matlab data,
I copied the matlab data to excel for simplicity

```{r}
dti_aparc_a2009s <- read_excel("../Data/fiber_counts_fs_ROI.xlsx", sheet=2) %>%
  rename("ROI1"="...1") %>%
  pivot_longer(cols=c(-ROI1), names_to="ROI2", values_to="n_Fiber_Conns")

dti_aparc <- read_excel("../Data/fiber_counts_fs_ROI.xlsx", sheet=1) %>%
  rename("ROI1"="...1") %>%
  pivot_longer(cols=c(-ROI1), names_to="ROI2", values_to="n_Fiber_Conns")

dti_conn_df <- rbind(dti_aparc_a2009s, dti_aparc) %>%
  filter(ROI1 != ROI2) %>%
  mutate(smushed = ifelse(ROI1<ROI2, paste(ROI1, ROI2, sep="_"),
         paste(ROI2, ROI1, sep="_"))) %>%
  distinct(smushed, .keep_all = T) %>%
  filter(str_detect(ROI1, "[u|U]nknown", negate=T),
         str_detect(ROI2, "[u|U]nknown", negate=T))
```


I will merge the Euclidean Distance and Fiber Connection pairwise info into one cohesive dataframe for analysis.
```{r}
pairwise.dist <- dti_conn_df %>%
  semi_join(., aseg.mni.fs.dists) %>%
  select(-ROI1, -ROI2) %>%
  left_join(., aseg.mni.fs.dists) %>%
  select(ROI1, ROI2, n_Fiber_Conns, Euclidean_Distance)
```

To show a sample:
```{r}
pairwise.dist %>%
  filter(n_Fiber_Conns>0) %>%
  sample_n(5) %>%
  kable(., booktabs=T) %>%
  kable_styling(full_width=F)
```



Save the resulting pairwise.dist dataframe to an .RData file for use in other scripts.
```{r}
save(pairwise.dist, file="RData/Pairwise_Dist.RData")
```

